<div class="card">
  <div class="card-header">
    <div class="row g-2 align-items-center">
      <div class="col">
        <h5 class="card-title">{{ '::Menu:Viajes' | abpLocalization }}</h5>
      </div>

      <div class="col-auto">
        <button
          class="btn btn-success d-flex align-items-center gap-2"
          *abpPermission="'EntrevistaABP.Viajes.Create'"
          (click)="openCrearModal()"
        >
          <i class="fa fa-plus"></i>
          <span class="d-none d-sm-inline">{{ '::Nuevo Viaje' | abpLocalization }}</span>
        </button>
      </div>
    </div>

    <form [formGroup]="filtroForm" class="row g-2 mt-3 align-items-end">
      <div class="col-12 col-lg-5">
        <label class="form-label">{{ '::Filtrar por fecha' | abpLocalization }}</label>
        <div class="d-flex gap-2">
          <input
            class="form-control"
            placeholder="Desde"
            formControlName="fechaDesde"
            ngbDatepicker
            #d1="ngbDatepicker"
            (click)="d1.toggle()"
          />
          <input
            class="form-control"
            placeholder="Hasta"
            formControlName="fechaHasta"
            ngbDatepicker
            #d2="ngbDatepicker"
            (click)="d2.toggle()"
          />
        </div>
      </div>
      <div class="col-auto d-flex align-items-end gap-2">
    <button type="button" class="btn btn-primary" (click)="aplicarFiltros()">
      <i class="fa fa-search me-1"></i> {{ '::Filtrar' | abpLocalization }}
    </button>

    <button type="button" class="btn btn-outline-secondary" (click)="limpiarFiltros()">
      <i class="fa fa-eraser me-1"></i> {{ '::Limpiar' | abpLocalization }}
    </button>
  </div>
    </form>

    <abp-modal [(visible)]="isModalOpen" [busy]="saving" size="lg">
      <ng-template #abpHeader>
        <h3 class="modal-title m-0 d-flex align-items-center gap-2">
          <i class="fa" [ngClass]="formMode === 'create' ? 'fa-plus-circle' : 'fa-edit'"></i>
          {{ (formMode === 'create' ? '::Crear Viaje' : '::Editar Viaje') | abpLocalization }}
        </h3>
      </ng-template>

      <ng-template #abpBody>
        <form [formGroup]="crearForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">{{ '::Salida' | abpLocalization }}</label>
              <input type="datetime-local" class="form-control" formControlName="fechaSalida" />
            </div>

            <div class="col-md-6">
              <label class="form-label">{{ '::Llegada' | abpLocalization }}</label>
              <input type="datetime-local" class="form-control" formControlName="fechaLlegada" />
            </div>

            <div class="col-md-6">
              <label class="form-label">{{ '::Origen' | abpLocalization }}</label>
              <input type="text" class="form-control" formControlName="origen" />
            </div>

            <div class="col-md-6">
              <label class="form-label">{{ '::Destino' | abpLocalization }}</label>
              <input type="text" class="form-control" formControlName="destino" />
            </div>

            <div class="col-md-6">
              <label class="form-label">{{ '::Transporte' | abpLocalization }}</label>
              <select class="form-select" formControlName="medioDeTransporte">
                <option [ngValue]="null">--</option>
                <option *ngFor="let m of mediosOpts" [ngValue]="m.value">{{ m.label }}</option>
              </select>
            </div>

            <div class="col-12" *ngIf="formMode === 'create'">
              <hr />
              <h6 class="mb-2">{{ '::Coordinador' | abpLocalization }}</h6>

              <div formGroupName="coordinadorNuevo" class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">{{ '::Nombre' | abpLocalization }}</label>
                  <input type="text" class="form-control" formControlName="nombre" />
                </div>

                <div class="col-md-6">
                  <label class="form-label">{{ '::Apellido' | abpLocalization }}</label>
                  <input type="text" class="form-control" formControlName="apellido" />
                </div>

                <div class="col-md-6">
                  <label class="form-label">DNI</label>
                  <input type="number" class="form-control" formControlName="dni" />
                </div>

                <div class="col-md-6">
                  <label class="form-label">{{ '::Fecha de nacimiento' | abpLocalization }}</label>
                  <input type="date" class="form-control" formControlName="fechaNacimiento" />
                </div>
              </div>
            </div>
          </div>
        </form>
      </ng-template>

      <ng-template #abpFooter>
        <button type="button" class="btn btn-outline-secondary" abpClose>
          {{ '::Cancelar' | abpLocalization }}
        </button>

        <button
          type="button"
          class="btn btn-primary"
          (click)="guardar()"
          [disabled]="crearForm.invalid || saving"
        >
          {{ (formMode === 'create' ? '::Guardar' : '::Actualizar') | abpLocalization }}
        </button>
      </ng-template>
    </abp-modal>

    <div class="card-body">
      <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-2">
        <div class="text-muted small">
          {{
            selectedViaje
              ? 'Seleccionado: ' +
                (selectedViaje.origen || '-') +
                ' → ' +
                (selectedViaje.destino || '-')
              : 'Sin selección'
          }}
        </div>

        <div class="d-flex gap-2">
          <button
            class="btn btn-outline-secondary"
            ngbTooltip="Ver pasajeros"
            (click)="VerPasajeros()"
            *abpPermission="'EntrevistaABP.Viajes.ManagePassengers'"
            [disabled]="!selectedViaje"
          >
            <i class="fa fa-users"></i>
          </button>

          <button
            class="btn btn-outline-secondary"
            ngbTooltip="Asignar pasajero"
            (click)="SeleccionarPasajeros()"
            *abpPermission="'EntrevistaABP.Viajes.Update'"
            [disabled]="!selectedViaje"
          >
            <i class="fa fa-user-plus"></i>
          </button>

          <button
            class="btn btn-outline-secondary"
            ngbTooltip="Cambiar coordinador"
            (click)="CambiarCoordinador()"
            *abpPermission="'EntrevistaABP.Viajes.Update'"
            [disabled]="!selectedViaje"
          >
            <i class="fa fa-user-shield"></i>
          </button>
        </div>
      </div>
      <ngx-datatable
        class="viajes-grid"
        [rows]="viajes.items"
        [count]="viajes.totalCount"
        [list]="list"
        [columnMode]="'force'"
        [headerHeight]="48"
        [footerHeight]="56"
        [rowHeight]="48"
        [selectionType]="SelectionType.single"
        [selected]="selected"
        (select)="onSelect($event)"
        (activate)="onActivate($event)"
        [rowClass]="rowClass"
        default
      >
        >
        <ngx-datatable-column
          [name]="'::Origen' | abpLocalization"
          prop="origen"
          [sortable]="true"
        ></ngx-datatable-column>

        <ngx-datatable-column
          [name]="'::Destino' | abpLocalization"
          prop="destino"
          [sortable]="true"
        ></ngx-datatable-column>

        <ngx-datatable-column
          [name]="'::Salida' | abpLocalization"
          prop="fechaSalida"
          [sortable]="true"
        >
          <ng-template let-row="row" ngx-datatable-cell-template>
            {{ row.fechaSalida | date : 'short' }}
          </ng-template>
        </ngx-datatable-column>

        <ngx-datatable-column
          [name]="'::Llegada' | abpLocalization"
          prop="fechaLlegada"
          [sortable]="true"
        >
          <ng-template let-row="row" ngx-datatable-cell-template>
            {{ row.fechaLlegada | date : 'short' }}
          </ng-template>
        </ngx-datatable-column>

        <ngx-datatable-column
          [name]="'::Transporte' | abpLocalization"
          prop="medioDeTransporte"
          [sortable]="true"
        >
          <ng-template let-row="row" ngx-datatable-cell-template>
            {{ row.medioDeTransporte | enumLabel : MedioEnum : medioLabels }}
          </ng-template>
        </ngx-datatable-column>

        <ngx-datatable-column [name]="'::Coordinador' | abpLocalization">
          <ng-template let-row="row" ngx-datatable-cell-template>
            {{
              (row.coordinador?.nombre || '') +
                (row.coordinador?.apellido ? ' ' + row.coordinador.apellido : '') || '-'
            }}
          </ng-template>
        </ngx-datatable-column>

        <ngx-datatable-column
          [name]="'::Acciones' | abpLocalization"
          [width]="120"
          [flexGrow]="0"
          [sortable]="false"
          *ngIf="canManage"

        >
          <ng-template let-row="row" ngx-datatable-cell-template>
            <div class="btn-group btn-group-sm text-nowrap" role="group">
              <button
                class="btn btn-outline-primary btn-icon"
                *abpPermission="'EntrevistaABP.Viajes.Update'"
                ngbTooltip="Editar"
                (click)="openEdit(row)"
              >
                <i class="fa fa-edit"></i>
              </button>
              <button
                class="btn btn-outline-danger btn-icon"
                *abpPermission="'EntrevistaABP.Viajes.Delete'"
                ngbTooltip="Eliminar"
                (click)="confirmDelete(row)"
              >
                <i class="fa fa-trash"></i>
              </button>
            </div>
          </ng-template>
        </ngx-datatable-column>
      </ngx-datatable>
    </div>
  </div>
</div>
<abp-modal [(visible)]="isManageOpen" [busy]="saving" size="md">
  <ng-template #abpHeader>
    <h3 class="modal-title m-0 d-flex align-items-center gap-2">
      <i class="fa" [ngClass]="manageMode === 'passenger' ? 'fa-user-plus' : 'fa-user-shield'"></i>
      {{ manageMode === 'passenger' ? 'Asignar pasajero' : 'Cambiar coordinador' }}
    </h3>
  </ng-template>

  <ng-template #abpBody>
    <form [formGroup]="manageForm" class="row g-3">
      <div class="col-12">
        <div class="form-check form-check-inline">
          <input
            class="form-check-input"
            type="radio"
            id="modoExistente"
            value="existente"
            formControlName="modo"
          />
          <label for="modoExistente" class="form-check-label">Existente por DNI</label>
        </div>
        <div class="form-check form-check-inline">
          <input
            class="form-check-input"
            type="radio"
            id="modoNuevo"
            value="nuevo"
            formControlName="modo"
          />
          <label for="modoNuevo" class="form-check-label">Cargar nuevo</label>
        </div>
      </div>

     
      <div class="col-md-6" *ngIf="manageForm.value.modo === 'existente'">
        <label class="form-label">DNI</label>
        <input
          type="number"
          class="form-control"
          formControlName="dniExistente"
          (keyup.enter)="guardarGestion()"
        />
      </div>

      
      <ng-container *ngIf="manageForm.value.modo === 'nuevo'">
        <div class="col-md-6">
          <label class="form-label">Nombre</label>
          <input type="text" class="form-control" formControlName="nombre" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Apellido</label>
          <input type="text" class="form-control" formControlName="apellido" />
        </div>
        <div class="col-md-6">
          <label class="form-label">DNI</label>
          <input type="number" class="form-control" formControlName="dni" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Fecha de nacimiento</label>
          <input type="date" class="form-control" formControlName="fechaNacimiento" />
        </div>
      </ng-container>
    </form>
  </ng-template>

  <ng-template #abpFooter>
    <button class="btn btn-outline-secondary" abpClose>Cancelar</button>
    <button
      class="btn btn-primary"
      (click)="guardarGestion()"
      [disabled]="saving || manageForm.invalid"
    >
      {{ manageMode === 'passenger' ? 'Asignar' : 'Cambiar' }}
    </button>
  </ng-template>
</abp-modal>


<abp-modal [(visible)]="isViewOpen" size="lg">
  <ng-template #abpHeader>
    <h3 class="modal-title m-0 d-flex align-items-center gap-2">
      <i class="fa fa-users"></i>
      Pasajeros del viaje
    </h3>
  </ng-template>

  <ng-template #abpBody>
    <div *ngIf="selectedViaje as v" class="mb-3 d-flex justify-content-between flex-wrap gap-2">
      <div>
        <b>{{ v.origen }}</b> → <b>{{ v.destino }}</b>
        <span class="text-muted ms-2"
          >({{ v.fechaSalida | date : 'short' }} – {{ v.fechaLlegada | date : 'short' }})</span
        >
      </div>
      <div class="text-nowrap">
        <span class="badge bg-secondary me-2">{{ v.pasajeros?.length || 0 }} pasajeros</span>
        <span class="badge bg-info text-dark">
          Coordinador:
          {{
            (v.coordinador?.nombre || '') +
              (v.coordinador?.apellido ? ' ' + v.coordinador.apellido : '') || '-'
          }}
        </span>
      </div>
    </div>

    <ul class="list-group mb-3" *ngIf="selectedViaje?.pasajeros?.length; else sinPasajeros">
      <li
        *ngFor="let p of selectedViaje!.pasajeros"
        class="list-group-item d-flex justify-content-between"
      >
        <span>
          <i class="fa fa-user me-2"></i>
          {{ p.nombre }} {{ p.apellido }}
          <small class="text-muted ms-2">DNI {{ p.dni }}</small>
        </span>
      </li>
    </ul>

    <ng-template #sinPasajeros>
      <div class="alert alert-light border">Este viaje no tiene pasajeros aún.</div>
    </ng-template>
  </ng-template>

  <ng-template #abpFooter>
    <button class="btn btn-outline-secondary" abpClose>Cerrar</button>
    <button
      class="btn btn-primary"
      (click)="openAgregarDesdeVista()"
      *abpPermission="'EntrevistaABP.Viajes.Update'"
    >
      <i class="fa fa-user-plus me-2"></i> Agregar pasajero
    </button>
  </ng-template>
</abp-modal>
